<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HVAC Tech Dispatch Log</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, Timestamp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        
        window.FirebaseModules = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, collection, addDoc, query, onSnapshot, orderBy, doc, updateDoc, deleteDoc, serverTimestamp, Timestamp };
    </script>

    <style>
        /* Base Theme */
        body { 
            background-color: #0f172a; 
            color: #f8fafc; 
            -webkit-tap-highlight-color: transparent; 
            font-family: ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        
        .glass-panel {
            background: linear-gradient(180deg, rgba(30, 41, 59, 0.8) 0%, rgba(15, 23, 42, 0.9) 100%);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Custom Gradients */
        .bg-gradient-dark {
            background: radial-gradient(circle at 50% 0%, #1e293b 0%, #020617 100%);
        }
        
        .text-glow {
            text-shadow: 0 0 20px rgba(56, 189, 248, 0.5);
        }

        /* Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-3px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 4s ease-in-out infinite; }
        
        /* Form Elements */
        input, textarea, select { 
            font-size: 16px !important; 
            background: rgba(15, 23, 42, 0.6) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
        }
        input:focus, textarea:focus, select:focus {
            border-color: #38bdf8 !important;
            box-shadow: 0 0 0 2px rgba(56, 189, 248, 0.2) !important;
        }
    </style>
</head>
<body class="bg-gradient-dark min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- ICONS (Fixed Sizing Logic) ---
        const Icons = {
            Plus: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>,
            Clock: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>,
            Calendar: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>,
            MapPin: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>,
            CheckCircle: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>,
            Play: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill={p.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>,
            ChevronLeft: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>,
            FileText: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>,
            User: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>,
            Trash2: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>,
            Navigation: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>,
            Download: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>,
            Wrench: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"></path></svg>,
            Box: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>,
            X: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Upload: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>,
            Save: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path><polyline points="17 21 17 13 7 13 7 21"></polyline><polyline points="7 3 7 8 15 8"></polyline></svg>,
            Hash: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="9" x2="20" y2="9"></line><line x1="4" y1="15" x2="20" y2="15"></line><line x1="10" y1="3" x2="8" y2="21"></line><line x1="16" y1="3" x2="14" y2="21"></line></svg>,
            Sun: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Moon: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Sunrise: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 18a5 5 0 0 0-10 0"></path><line x1="12" y1="2" x2="12" y2="9"></line><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line><line x1="1" y1="18" x2="3" y2="18"></line><line x1="21" y1="18" x2="23" y2="18"></line><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line><line x1="23" y1="22" x2="1" y2="22"></line><polyline points="8 6 12 2 16 6"></polyline></svg>,
            Sunset: ({size=24, ...p}) => <svg width={size} height={size} {...p} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M17 18a5 5 0 0 0-10 0"></path><line x1="12" y1="9" x2="12" y2="2"></line><line x1="4.22" y1="10.22" x2="5.64" y2="11.64"></line><line x1="1" y1="18" x2="3" y2="18"></line><line x1="21" y1="18" x2="23" y2="18"></line><line x1="18.36" y1="11.64" x2="19.78" y2="10.22"></line><line x1="23" y1="22" x2="1" y2="22"></line><polyline points="16 5 12 9 8 5"></polyline></svg>
        };

        // --- FIREBASE ---
        let dbMode = 'local';
        let firebaseUser = null;
        let db = null;
        let auth = null;
        let appId = 'default';
        
        if (typeof window.FirebaseModules !== 'undefined' && typeof __firebase_config !== 'undefined') {
            try {
                const { initializeApp, getAuth, getFirestore, signInAnonymously, signInWithCustomToken, onAuthStateChanged } = window.FirebaseModules;
                const firebaseConfig = JSON.parse(__firebase_config);
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                dbMode = 'firebase';
                const initAuth = async () => {
                     if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                };
                initAuth();
            } catch (e) { console.log("Firebase init failed", e); }
        }

        // --- ASTRONOMY LOGIC ---
        const getMoonPhase = (date) => {
            let year = date.getFullYear();
            let month = date.getMonth() + 1;
            let day = date.getDate();
            if (month < 3) { year--; month += 12; }
            ++month;
            let c = 365.25 * year;
            let e = 30.6 * month;
            let jd = c + e + day - 694039.09; 
            jd /= 29.5305882;
            let b = parseInt(jd);
            jd -= b; 
            b = Math.round(jd * 8); 
            if (b >= 8) b = 0; 
            
            const phases = ['New Moon', 'Waxing Crescent', 'First Quarter', 'Waxing Gibbous', 'Full Moon', 'Waning Gibbous', 'Last Quarter', 'Waning Crescent'];
            return phases[b];
        };

        const getWeatherDesc = (code) => {
            if (code === 0) return "Clear";
            if (code >= 1 && code <= 3) return "Partly Cloudy";
            if (code >= 45 && code <= 48) return "Foggy";
            if (code >= 51 && code <= 67) return "Rainy";
            if (code >= 71 && code <= 77) return "Snow";
            if (code >= 80 && code <= 82) return "Showers";
            if (code >= 95) return "Thunderstorm";
            return "Unknown";
        };

        const fetchWeather = async () => {
            try {
                let lat = 32.5554; let long = -95.8641;
                if (navigator.geolocation) {
                    try {
                        const pos = await new Promise((resolve, reject) => navigator.geolocation.getCurrentPosition(resolve, reject, {timeout: 3000}));
                        lat = pos.coords.latitude; long = pos.coords.longitude;
                    } catch (e) {}
                }
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${long}&current=temperature_2m,weather_code&daily=sunrise,sunset&temperature_unit=fahrenheit&timezone=auto`);
                const data = await res.json();
                
                if (data.current && data.daily) {
                    const sr = new Date(data.daily.sunrise[0]);
                    const ss = new Date(data.daily.sunset[0]);
                    const formatTimeShort = (d) => d.toLocaleTimeString([], {hour:'numeric', minute:'2-digit'});
                    return {
                        temp: Math.round(data.current.temperature_2m),
                        code: data.current.weather_code,
                        desc: getWeatherDesc(data.current.weather_code),
                        sunrise: formatTimeShort(sr),
                        sunset: formatTimeShort(ss),
                        moon: getMoonPhase(new Date()),
                        fetchedAt: new Date().toISOString()
                    };
                }
            } catch (e) { }
            return null;
        };

        // --- HELPERS & PARSERS (Same as before) ---
        const parseAddress = (rawAddr) => {
            if (!rawAddr) return null;
            const regex = /^(.*?),\s*(.*?),\s*([A-Z]{2})\s+(\d{5}(?:-\d{4})?)(?:\s+USA)?$/i;
            const match = rawAddr.match(regex);
            return match ? { street: match[1].trim(), city: match[2].trim(), state: match[3].trim(), zip: match[4].trim(), raw: rawAddr } : { raw: rawAddr };
        };

        const parseCustomer = (rawName) => {
            if (!rawName) return null;
            const regex = /^([^,]+),\s*(?:(DR\.|MR\.|MRS\.|MS\.|MSGR\.)\s*)?([^-]+?)(?:\s*-\s*(.*))?(?:\s*\(([MF])\))?$/i;
            const match = rawName.match(regex);
            if (match) return { lastName: match[1].trim(), title: match[2] ? match[2].trim() : '', firstName: match[3].trim(), company: match[4] ? match[4].trim() : '', gender: match[5] ? match[5].toUpperCase() : '', raw: rawName };
            const simpleRegex = /^([^,]+),\s*(.*)$/;
            const simpleMatch = rawName.match(simpleRegex);
            if (simpleMatch) return { lastName: simpleMatch[1].trim(), firstName: simpleMatch[2].trim(), raw: rawName };
            return { raw: rawName };
        };

        const parseDate = (dateInput) => {
            if (!dateInput) return new Date();
            if (dateInput.toDate) return dateInput.toDate(); 
            if (typeof dateInput === 'string' && dateInput.includes('-') && !dateInput.includes('T')) return new Date(dateInput + 'T12:00:00'); 
            return new Date(dateInput);
        };

        const formatTime = (d) => !d ? '--:--' : parseDate(d).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const formatDate = (d) => !d ? '' : parseDate(d).toLocaleDateString([], { month: 'short', day: 'numeric', year: 'numeric' });
        const toInputDateString = (d) => !d ? '' : parseDate(d).getFullYear() + '-' + String(parseDate(d).getMonth()+1).padStart(2,'0') + '-' + String(parseDate(d).getDate()).padStart(2,'0');
        const formatDuration = (ms) => (!ms || ms < 0) ? "0h 0m" : `${Math.floor(ms / 3600000)}h ${Math.round((ms % 3600000) / 60000)}m`;
        const getSmartStatus = (job) => job.timeFinished ? 'completed' : (job.timeArrived ? 'in_progress' : 'scheduled');
        const getSafeDurationMs = (job) => {
            if (!job.timeArrived || !job.timeFinished) return 0;
            const start = parseDate(job.timeArrived); const end = parseDate(job.timeFinished);
            const d1 = new Date(); d1.setHours(start.getHours(), start.getMinutes(), 0, 0);
            const d2 = new Date(); d2.setHours(end.getHours(), end.getMinutes(), 0, 0);
            let diff = d2 - d1; if (diff < 0) diff += 24 * 60 * 60 * 1000; 
            return diff;
        };

        // --- COMPONENTS ---

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('list');
            const [selectedJobId, setSelectedJobId] = useState(null);
            const [currentWeather, setCurrentWeather] = useState(null);

            useEffect(() => {
                if (dbMode === 'firebase' && auth) {
                    window.FirebaseModules.onAuthStateChanged(auth, (u) => setUser(u));
                } else { setUser({ uid: 'local-user' }); }
            }, []);

            useEffect(() => {
                const getW = async () => { const w = await fetchWeather(); if (w) setCurrentWeather(w); };
                getW();
                const interval = setInterval(getW, 30 * 60 * 1000);
                return () => clearInterval(interval);
            }, []);

            if (!user) return <div className="h-screen flex items-center justify-center text-slate-500">Loading App...</div>;

            return (
                <div className="min-h-screen pb-6">
                    {view === 'list' && <Dashboard user={user} currentWeather={currentWeather} onAdd={() => setView('add')} onSelectJob={(id) => { setSelectedJobId(id); setView('detail'); }} />}
                    {view === 'add' && <AddJobForm user={user} currentWeather={currentWeather} onCancel={() => setView('list')} onSuccess={() => setView('list')} />}
                    {view === 'detail' && <JobDetail user={user} jobId={selectedJobId} onBack={() => { setSelectedJobId(null); setView('list'); }} />}
                </div>
            );
        }

        function Dashboard({ user, currentWeather, onAdd, onSelectJob }) {
            const [jobs, setJobs] = useState([]);
            const [showMenu, setShowMenu] = useState(false);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (dbMode === 'firebase') {
                    const { collection, query, orderBy, onSnapshot } = window.FirebaseModules;
                    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'jobs'), orderBy('createdAt', 'desc'));
                    return onSnapshot(q, (snap) => setJobs(snap.docs.map(d => ({ id: d.id, ...d.data() }))));
                } else {
                    const localJobs = JSON.parse(localStorage.getItem('hvac_jobs') || '[]');
                    localJobs.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                    setJobs(localJobs);
                }
            }, [user]);

            const now = new Date();
            const todayLocal = now.getFullYear() + '-' + String(now.getMonth()+1).padStart(2,'0') + '-' + String(now.getDate()).padStart(2,'0');
            const jobsToday = jobs.filter(j => toInputDateString(j.date) === todayLocal);
            const oneWeekAgo = new Date(); oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const jobsWeek = jobs.filter(j => parseDate(j.date) >= oneWeekAgo && (j.status === 'completed' || j.timeFinished));

            const handleBackup = () => {
                const blob = new Blob([JSON.stringify(jobs, null, 2)], {type: "application/json"});
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `HVAC_BACKUP_${todayLocal}.json`; a.click(); setShowMenu(false);
            };
            const handleRestoreClick = () => fileInputRef.current.click();
            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const importedJobs = JSON.parse(event.target.result);
                        if (!Array.isArray(importedJobs)) throw new Error("Invalid backup file");
                        if(confirm(`Found ${importedJobs.length} jobs in backup.\n\nClick OK to MERGE with existing jobs.\nClick Cancel to stop.`)) {
                            const existingIds = new Set(jobs.map(j => j.id));
                            const newJobs = [...jobs];
                            let addedCount = 0;
                            importedJobs.forEach(j => { if(!existingIds.has(j.id)) { newJobs.push(j); addedCount++; } });
                            localStorage.setItem('hvac_jobs', JSON.stringify(newJobs));
                            setJobs(newJobs);
                            alert(`Successfully restored! Added ${addedCount} new jobs.`);
                            setShowMenu(false);
                        }
                    } catch (err) { alert("Error restoring file."); }
                };
                reader.readAsText(file);
                e.target.value = null; 
            };
            const handleBulkExport = (range) => { 
                setShowMenu(false);
                let filteredJobs = [];
                let title = "";
                const today = new Date();
                
                if (range === 'today') {
                    title = "Todays_Log";
                    const tLocal = today.getFullYear() + '-' + String(today.getMonth()+1).padStart(2,'0') + '-' + String(today.getDate()).padStart(2,'0');
                    filteredJobs = jobs.filter(j => {
                        const d = parseDate(j.date);
                        return (d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0')) === tLocal;
                    });
                } else if (range === 'week') {
                    title = "Weekly_Log";
                    const startOfWeek = new Date(today);
                    startOfWeek.setDate(today.getDate() - today.getDay());
                    startOfWeek.setHours(0,0,0,0);
                    filteredJobs = jobs.filter(j => parseDate(j.date) >= startOfWeek);
                } else if (range === 'month') {
                    title = "Monthly_Log";
                    const startOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
                    filteredJobs = jobs.filter(j => parseDate(j.date) >= startOfMonth);
                } else if (range === 'all') {
                    title = "FULL_HISTORY";
                    filteredJobs = [...jobs];
                }

                if (filteredJobs.length === 0) {
                    alert("No jobs found for this period.");
                    return;
                }

                filteredJobs.sort((a, b) => parseDate(a.date) - parseDate(b.date));

                let totalMs = 0;
                filteredJobs.forEach(j => { totalMs += getSafeDurationMs(j); });

                let txt = `HVAC SERVICE REPORT\nPERIOD: ${range.toUpperCase()}\nGENERATED: ${today.toLocaleString()}\n--------------------------------------------------\nSUMMARY:\nTOTAL JOBS:   ${filteredJobs.length}\nTOTAL HOURS:  ${formatDuration(totalMs)}\n--------------------------------------------------\n\n`;
                filteredJobs.forEach((job, idx) => {
                   const parsedAddr = parseAddress(job.address);
                   const parsedName = parseCustomer(job.customerName);
                   const weatherStr = job.weather ? `${job.weather.temp}°F ${job.weather.desc}` : 'N/A';
                   const astroStr = job.weather && job.weather.sunrise ? `Sunrise ${job.weather.sunrise} | Sunset ${job.weather.sunset}` : 'N/A';
                   const moonStr = job.weather && job.weather.moon ? job.weather.moon : 'N/A';
                   
                   txt += `JOB #${idx + 1} | ${formatDate(job.date)}\n`;
                   txt += `CUSTOMER: ${job.customerName}\n`;
                   if (parsedName && parsedName.firstName) {
                       txt += `   -> First: ${parsedName.firstName}, Last: ${parsedName.lastName}\n`;
                       if (parsedName.company) txt += `   -> Company: ${parsedName.company}\n`;
                   }
                   txt += `ADDRESS:  ${job.address}\n`;
                   if (parsedAddr && parsedAddr.city) {
                       txt += `   -> City: ${parsedAddr.city}, Zip: ${parsedAddr.zip}\n`;
                   }
                   txt += `WEATHER:  ${weatherStr}\n`;
                   txt += `SOLAR:    ${astroStr}\n`;
                   txt += `MOON:     ${moonStr}\n`;
                   txt += `TIME:     ${formatTime(job.timeArrived)} - ${formatTime(job.timeFinished)} (${formatDuration(getSafeDurationMs(job))})\n`;
                   txt += `NOTES:    ${job.workPerformed || job.description || 'N/A'}\nPARTS:    ${job.partsUsed || 'N/A'}\n--------------------------------------------------\n\n`;
                });

                const blob = new Blob([txt], {type: 'text/plain'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url; a.download = `HVAC_${title}_${todayLocal}.txt`;
                a.click();
            };

            return (
                <div className="pb-20 animate-fade-in relative">
                    {/* HEADER */}
                    <header className="glass-panel sticky top-0 z-20 px-4 pt-4 pb-3 shadow-lg rounded-b-2xl">
                        <div className="flex justify-between items-start">
                            <div>
                                <h1 className="text-2xl font-bold text-white tracking-tight text-glow">HVAC Dispatch</h1>
                                <p className="text-sm text-slate-400 font-medium">{new Date().toLocaleDateString(undefined, { weekday: 'long', month: 'long', day: 'numeric' })}</p>
                            </div>
                            <div className="flex gap-2">
                                <button onClick={() => setShowMenu(true)} className="bg-slate-800/80 p-2.5 rounded-xl text-cyan-400 hover:bg-slate-700 border border-slate-700 transition-colors"><Icons.FileText size={20} /></button>
                                <div className="bg-slate-800/80 p-2.5 rounded-xl border border-slate-700"><Icons.User className="text-slate-400" size={20} /></div>
                            </div>
                        </div>
                        
                        {/* WEATHER WIDGET */}
                        {currentWeather && (
                            <div className="mt-4 flex items-center justify-between bg-slate-900/50 rounded-xl p-3 border border-slate-800/50">
                                <div className="flex items-center gap-3">
                                    <Icons.Sun size={24} className="text-amber-400 animate-pulse" />
                                    <div>
                                        <div className="text-xl font-bold text-white leading-none">{currentWeather.temp}°F</div>
                                        <div className="text-xs text-slate-400">{currentWeather.desc}</div>
                                    </div>
                                </div>
                                <div className="flex flex-col items-end text-xs text-slate-500 gap-1">
                                    <span className="flex items-center gap-1 text-orange-300"><Icons.Sunrise size={12}/> {currentWeather.sunrise}</span>
                                    <span className="flex items-center gap-1 text-purple-300"><Icons.Sunset size={12}/> {currentWeather.sunset}</span>
                                    <span className="flex items-center gap-1 text-blue-300"><Icons.Moon size={12}/> {currentWeather.moon}</span>
                                </div>
                            </div>
                        )}
                    </header>

                    {/* HUD STATS */}
                    <div className="px-4 py-5 grid grid-cols-2 gap-4">
                        <div className="glass rounded-2xl p-4 relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><Icons.Calendar size={48} /></div>
                            <span className="text-blue-300 text-xs font-bold uppercase tracking-wider">Today's Jobs</span>
                            <div className="text-4xl font-bold text-white mt-1 group-hover:scale-105 transition-transform text-glow">{jobsToday.length}</div>
                        </div>
                        <div className="glass rounded-2xl p-4 relative overflow-hidden group">
                            <div className="absolute top-0 right-0 p-2 opacity-10"><Icons.CheckCircle size={48} /></div>
                            <span className="text-emerald-300 text-xs font-bold uppercase tracking-wider">Completed (Week)</span>
                            <div className="text-4xl font-bold text-emerald-400 mt-1 group-hover:scale-105 transition-transform">{jobsWeek.length}</div>
                        </div>
                    </div>

                    <div className="px-4 space-y-4">
                        {jobs.length === 0 ? (
                             <div className="text-center py-12 glass rounded-2xl border-dashed border-slate-700">
                                <p className="text-slate-400 mb-3">No jobs logged yet.</p>
                                <button onClick={onAdd} className="text-cyan-400 text-sm font-bold hover:underline">Tap + to start your day</button>
                            </div>
                        ) : (
                            jobs.map(job => {
                                const displayStatus = getSmartStatus(job);
                                const statusColor = displayStatus === 'in_progress' ? 'bg-amber-500/20 text-amber-400 border-amber-500/30 animate-pulse' 
                                                  : displayStatus === 'completed' ? 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20' 
                                                  : 'bg-blue-500/10 text-blue-400 border-blue-500/20';
                                
                                return (
                                <div key={job.id} onClick={() => onSelectJob(job.id)} className="glass rounded-2xl p-5 active:scale-[0.98] transition-all hover:border-slate-600 cursor-pointer relative overflow-hidden">
                                    <div className={`absolute left-0 top-0 bottom-0 w-1 ${displayStatus === 'in_progress' ? 'bg-amber-500' : displayStatus === 'completed' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                                    
                                    <div className="flex justify-between items-start mb-2 pl-2">
                                        <div className={`px-2.5 py-1 rounded-md text-[10px] font-bold uppercase tracking-wide border ${statusColor}`}>
                                            {displayStatus === 'in_progress' ? 'On Site' : displayStatus === 'completed' ? 'Completed' : 'Scheduled'}
                                        </div>
                                        <span className="text-xs text-slate-500 font-mono">{formatDate(job.date)}</span>
                                    </div>
                                    
                                    <div className="pl-2">
                                        <h3 className="font-bold text-white text-lg leading-tight mb-1 line-clamp-1">{job.customerName}</h3>
                                        <div className="flex items-start text-slate-400 text-sm mb-4">
                                            <Icons.MapPin size={14} className="mt-0.5 mr-1.5 shrink-0 text-slate-500" />
                                            <span className="line-clamp-1">{job.address}</span>
                                        </div>
                                        
                                        <div className="bg-slate-950/50 rounded-lg p-2 flex items-center justify-between text-xs font-mono border border-slate-800">
                                            <div className="text-slate-400">ARRIVED: <span className="text-white">{formatTime(job.timeArrived)}</span></div>
                                            <div className="h-3 w-px bg-slate-700"></div>
                                            <div className="text-slate-400">FINISHED: <span className="text-white">{formatTime(job.timeFinished)}</span></div>
                                        </div>
                                    </div>
                                </div>
                            )})
                        )}
                    </div>

                    <button onClick={onAdd} className="fixed bottom-6 right-6 w-16 h-16 bg-cyan-500 hover:bg-cyan-400 text-white rounded-full shadow-[0_0_20px_rgba(6,182,212,0.5)] flex items-center justify-center active:scale-90 transition-all z-50 animate-float">
                        <Icons.Plus size={32} />
                    </button>

                    {showMenu && <div className="fixed inset-0 bg-black/90 backdrop-blur-sm z-50 flex items-center justify-center p-6" onClick={() => setShowMenu(false)}>
                        <div className="glass-panel w-full max-w-sm rounded-2xl overflow-hidden p-6 space-y-6" onClick={e => e.stopPropagation()}>
                            <div className="flex justify-between items-center">
                                <h3 className="text-xl font-bold text-white">Tools</h3>
                                <button onClick={() => setShowMenu(false)}><Icons.X className="text-slate-400"/></button>
                            </div>
                            <div className="space-y-3">
                                <div className="bg-slate-900/50 p-3 rounded-xl border border-slate-700 space-y-2">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Reports</div>
                                    <button onClick={() => handleBulkExport('today')} className="w-full p-2 flex items-center justify-between text-slate-300 hover:text-white text-sm">Today<Icons.Download size={16} className="text-blue-400"/></button>
                                    <button onClick={() => handleBulkExport('week')} className="w-full p-2 flex items-center justify-between text-slate-300 hover:text-white text-sm">This Week<Icons.Download size={16} className="text-emerald-400"/></button>
                                    <button onClick={() => handleBulkExport('month')} className="w-full p-2 flex items-center justify-between text-slate-300 hover:text-white text-sm">This Month<Icons.Download size={16} className="text-purple-400"/></button>
                                    <div className="h-px bg-slate-700 my-1"></div>
                                    <button onClick={() => handleBulkExport('all')} className="w-full p-2 flex items-center justify-between text-white font-bold text-sm">Export Everything<Icons.Download size={16} className="text-orange-400"/></button>
                                </div>
                                <div className="bg-slate-900/50 p-3 rounded-xl border border-slate-700 space-y-2">
                                    <div className="text-[10px] text-slate-500 font-bold uppercase tracking-wider mb-1">Data Management</div>
                                    <button onClick={handleBackup} className="w-full p-2 flex items-center justify-between text-slate-300 hover:text-white text-sm">Backup (.json)<Icons.Save size={16} className="text-amber-400"/></button>
                                    <button onClick={handleRestoreClick} className="w-full p-2 flex items-center justify-between text-slate-300 hover:text-white text-sm">Restore Data<Icons.Upload size={16} className="text-cyan-400"/></button>
                                </div>
                                <input type="file" ref={fileInputRef} onChange={handleFileChange} className="hidden" accept=".json" />
                            </div>
                        </div>
                    </div>}
                </div>
            );
        }

        function AddJobForm({ user, currentWeather, onCancel, onSuccess }) {
            const today = new Date();
            const todayStr = toInputDateString(today);
            const [form, setForm] = useState({ customerName: '', address: '', description: '', jobType: 'Repair', date: todayStr });

            const handleSubmit = (e) => {
                e.preventDefault(); if(!form.customerName) return;
                const newJob = { ...form, status: 'scheduled', createdAt: new Date().toISOString(), timeArrived: null, timeFinished: null, workPerformed: '', partsUsed: '', weather: currentWeather || null };
                if (dbMode === 'firebase') {
                    const dateObj = new Date(form.date + 'T12:00:00');
                    window.FirebaseModules.addDoc(window.FirebaseModules.collection(db, 'artifacts', appId, 'users', user.uid, 'jobs'), { ...newJob, date: window.FirebaseModules.Timestamp.fromDate(dateObj), createdAt: window.FirebaseModules.serverTimestamp() }).then(onSuccess);
                } else {
                    const jobs = JSON.parse(localStorage.getItem('hvac_jobs') || '[]'); newJob.id = 'local_' + Date.now(); jobs.push(newJob); localStorage.setItem('hvac_jobs', JSON.stringify(jobs)); onSuccess();
                }
            };

            return (
                <div className="bg-gradient-dark min-h-screen flex flex-col">
                    <div className="glass-panel px-4 py-4 sticky top-0 z-20 flex items-center gap-4">
                        <button onClick={onCancel} className="p-2 rounded-full bg-slate-800 text-slate-300"><Icons.ChevronLeft size={24} /></button>
                        <h2 className="text-lg font-bold text-white">New Dispatch</h2>
                    </div>
                    <form onSubmit={handleSubmit} className="p-6 space-y-6 flex-1">
                        <div className="space-y-5">
                            <div>
                                <label className="text-xs font-bold text-cyan-400 uppercase tracking-wider mb-2 block">Customer</label>
                                <input autoFocus type="text" className="w-full p-4 rounded-xl text-white outline-none transition-all" value={form.customerName} onChange={e => setForm({...form, customerName: e.target.value})} placeholder="NAME, TITLE..." />
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Location</label>
                                <div className="relative">
                                    <Icons.MapPin size={20} className="absolute left-4 top-4 text-slate-500" />
                                    <input type="text" className="w-full p-4 pl-12 rounded-xl text-white outline-none transition-all" value={form.address} onChange={e => setForm({...form, address: e.target.value})} />
                                </div>
                            </div>
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Date</label>
                                    <input type="date" className="w-full p-4 rounded-xl text-white outline-none" value={form.date} onChange={e => setForm({...form, date: e.target.value})} />
                                </div>
                                <div>
                                    <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Type</label>
                                    <select className="w-full p-4 rounded-xl text-white outline-none" value={form.jobType} onChange={e => setForm({...form, jobType: e.target.value})}>
                                        <option>Repair</option><option>Maintenance</option><option>Install</option><option>Estimate</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label className="text-xs font-bold text-slate-500 uppercase tracking-wider mb-2 block">Dispatch Notes</label>
                                <textarea rows="4" className="w-full p-4 rounded-xl text-white outline-none" value={form.description} onChange={e => setForm({...form, description: e.target.value})} />
                            </div>
                        </div>
                        <button type="submit" disabled={!form.customerName} className="w-full bg-cyan-500 hover:bg-cyan-400 text-white font-bold py-4 rounded-xl shadow-lg shadow-cyan-500/20 flex items-center justify-center gap-2 disabled:opacity-50 disabled:shadow-none transition-all transform active:scale-95">
                            <Icons.CheckCircle size={24} /> Create Ticket
                        </button>
                    </form>
                </div>
            );
        }

        function JobDetail({ user, jobId, onBack }) {
            const [job, setJob] = useState(null);
            const [editMode, setEditMode] = useState(false);

            useEffect(() => {
                if (dbMode === 'firebase') {
                    const unsub = window.FirebaseModules.onSnapshot(window.FirebaseModules.doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', jobId), (s) => { if(s.exists()) setJob({id: s.id, ...s.data()}); });
                    return () => unsub();
                } else {
                    const jobs = JSON.parse(localStorage.getItem('hvac_jobs') || '[]');
                    setJob(jobs.find(j => j.id === jobId));
                }
            }, [jobId]);

            const updateJob = (updates) => { if(dbMode==='firebase') window.FirebaseModules.updateDoc(window.FirebaseModules.doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', jobId), updates); else { const jobs=JSON.parse(localStorage.getItem('hvac_jobs')); const idx=jobs.findIndex(j=>j.id===jobId); jobs[idx]={...jobs[idx], ...updates}; localStorage.setItem('hvac_jobs', JSON.stringify(jobs)); setJob(jobs[idx]); }};
            const deleteJob = () => { if(confirm("Delete?")) { if(dbMode==='firebase') window.FirebaseModules.deleteDoc(window.FirebaseModules.doc(db, 'artifacts', appId, 'users', user.uid, 'jobs', jobId)).then(onBack); else { const jobs=JSON.parse(localStorage.getItem('hvac_jobs')).filter(j=>j.id!==jobId); localStorage.setItem('hvac_jobs', JSON.stringify(jobs)); onBack(); }}};
            const handleArrive = () => updateJob({ status: 'in_progress', timeArrived: dbMode==='firebase'?window.FirebaseModules.Timestamp.now():new Date().toISOString() });
            const handleFinish = () => updateJob({ status: 'completed', timeFinished: dbMode==='firebase'?window.FirebaseModules.Timestamp.now():new Date().toISOString() });
            const handleManualTime = (field, val) => { if(!val)return; const [h,m]=val.split(':').map(Number); let b=parseDate(job.date); b.setHours(h,m,0,0); const v=dbMode==='firebase'?window.FirebaseModules.Timestamp.fromDate(b):b.toISOString(); const u={[field]:v}; if(field==='timeFinished')u.status='completed'; else if(field==='timeArrived'&&!job.timeFinished)u.status='in_progress'; updateJob(u); };
            const handleDateChange = (d) => { if(!d)return; if(dbMode==='firebase'){const o=new Date(d+'T12:00:00'); updateJob({date:window.FirebaseModules.Timestamp.fromDate(o)})}else{updateJob({date:d})} };
            const handleExport = () => { 
                const d = parseDate(job.date); const safeAddr = job.address.replace(/[^a-z0-9]/gi, '_').substring(0,20); const fname = `${d.toISOString().split('T')[0]}_${safeAddr}.txt`;
                const w = job.weather ? `${job.weather.temp}°F ${job.weather.desc}` : 'N/A';
                const txt = `HVAC LOG\n----------------\nCust: ${job.customerName}\nAddr: ${job.address}\nDate: ${formatDate(job.date)}\n\nWeather: ${w}\nArrived: ${formatTime(job.timeArrived)}\nFinished: ${formatTime(job.timeFinished)}\nTotal: ${formatDuration(getSafeDurationMs(job))}\n\nNOTES:\n${job.description}\nWORK:\n${job.workPerformed}\nPARTS:\n${job.partsUsed}\n`;
                const b=new Blob([txt],{type:'text/plain'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download=fname; a.click();
            };

            if(!job) return <div>Loading...</div>;
            const displayStatus = getSmartStatus(job);
            const parsedAddr = parseAddress(job.address);
            const parsedName = parseCustomer(job.customerName);

            return (
                <div className="bg-gradient-dark min-h-screen pb-10">
                    <div className="glass-panel px-4 py-4 sticky top-0 z-20 flex items-center justify-between">
                        <div className="flex items-center gap-4">
                            <button onClick={onBack} className="p-2 rounded-full bg-slate-800 text-slate-300 hover:text-white"><Icons.ChevronLeft size={24} /></button>
                            <span className="text-sm font-bold uppercase tracking-widest text-slate-500">Job Details</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={() => setEditMode(!editMode)} className={`p-2 rounded-full ${editMode ? 'bg-cyan-500 text-white' : 'bg-slate-800 text-slate-400'}`}><Icons.Clock size={20} /></button>
                            <button onClick={deleteJob} className="p-2 rounded-full bg-slate-800 text-red-400 hover:bg-red-500/20"><Icons.Trash2 size={20} /></button>
                        </div>
                    </div>

                    <div className="p-4 space-y-6">
                        <div className="glass rounded-2xl p-5 relative overflow-hidden">
                            <div className={`absolute top-0 left-0 right-0 h-1 ${displayStatus === 'in_progress' ? 'bg-amber-500' : displayStatus === 'completed' ? 'bg-emerald-500' : 'bg-blue-500'}`}></div>
                            <h1 className="text-2xl font-bold text-white leading-tight mt-2 mb-1">{job.customerName}</h1>
                            <p className="text-slate-400 text-sm mb-4 flex items-center gap-2"><Icons.MapPin size={14} className="text-cyan-400"/> {job.address}</p>
                            
                            <div className="flex items-center gap-2 text-sm text-slate-300 bg-slate-800/50 p-2 rounded-lg w-fit">
                                <Icons.Calendar size={16} />
                                {editMode ? <input type="date" className="bg-transparent text-white text-xs" value={toInputDateString(job.date)} onChange={(e) => handleDateChange(e.target.value)} /> : <span>{formatDate(job.date)}</span>}
                            </div>
                        </div>

                        {(parsedAddr || parsedName) && (
                            <div className="glass rounded-2xl p-4 text-xs">
                                <div className="flex items-center gap-2 mb-3 text-slate-500 uppercase tracking-wider font-bold border-b border-slate-700 pb-2">
                                    <Icons.Hash size={14} /> Customer Profile
                                </div>
                                <div className="grid grid-cols-2 gap-y-3 gap-x-4 text-slate-300">
                                    {parsedName?.firstName && <div><span className="text-slate-500 block text-[10px] uppercase">First Name</span>{parsedName.firstName}</div>}
                                    {parsedName?.lastName && <div><span className="text-slate-500 block text-[10px] uppercase">Last Name</span>{parsedName.lastName}</div>}
                                    {parsedAddr?.city && <div><span className="text-slate-500 block text-[10px] uppercase">City</span>{parsedAddr.city}</div>}
                                    {parsedAddr?.zip && <div><span className="text-slate-500 block text-[10px] uppercase">Zip</span>{parsedAddr.zip}</div>}
                                </div>
                            </div>
                        )}

                        <div className="grid grid-cols-2 gap-4">
                            <div className={`glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 border-t-4 ${job.timeArrived ? 'border-t-cyan-500' : 'border-t-slate-700'}`}>
                                <span className="text-xs font-bold text-slate-400 uppercase">Arrival</span>
                                {editMode ? 
                                    <input type="time" className="bg-slate-800 p-2 rounded text-white text-center w-full" value={!job.timeArrived?'':parseDate(job.timeArrived).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})} onChange={e=>handleManualTime('timeArrived',e.target.value)} /> :
                                    (job.timeArrived ? <div className="text-2xl font-bold text-white">{formatTime(job.timeArrived)}</div> : 
                                    <button onClick={handleArrive} className="w-full py-3 bg-cyan-500 hover:bg-cyan-400 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-cyan-500/30"><Icons.Play size={20}/> Start</button>)
                                }
                            </div>
                            <div className={`glass rounded-2xl p-4 flex flex-col items-center justify-center gap-3 border-t-4 ${job.timeFinished ? 'border-t-emerald-500' : 'border-t-slate-700'}`}>
                                <span className="text-xs font-bold text-slate-400 uppercase">Finish</span>
                                {editMode ? 
                                    <input type="time" className="bg-slate-800 p-2 rounded text-white text-center w-full" value={!job.timeFinished?'':parseDate(job.timeFinished).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit',hour12:false})} onChange={e=>handleManualTime('timeFinished',e.target.value)} /> :
                                    (job.timeFinished ? <div className="text-2xl font-bold text-white">{formatTime(job.timeFinished)}</div> : 
                                    <button onClick={handleFinish} disabled={!job.timeArrived} className="w-full py-3 bg-emerald-500 hover:bg-emerald-400 disabled:bg-slate-800 disabled:text-slate-600 text-white font-bold rounded-xl flex items-center justify-center gap-2 shadow-lg shadow-emerald-500/30"><Icons.CheckCircle size={20}/> Done</button>)
                                }
                            </div>
                        </div>

                        {job.timeArrived && job.timeFinished && (
                            <div className="glass rounded-xl p-4 flex justify-between items-center border border-slate-700/50">
                                <span className="text-slate-400 text-sm font-bold uppercase">Billable Duration</span>
                                <span className="text-2xl font-bold text-white text-glow">{formatDuration(getSafeDurationMs(job))}</span>
                            </div>
                        )}

                        <div className="space-y-4">
                            <div className="glass rounded-2xl p-4">
                                <div className="flex items-center gap-2 mb-2 text-slate-400"><Icons.Wrench size={16}/><span className="text-xs font-bold uppercase">Work Performed</span></div>
                                <textarea className="w-full p-3 rounded-xl text-white outline-none text-sm min-h-[100px]" placeholder="Describe work..." defaultValue={job.workPerformed} onBlur={(e) => updateJob({workPerformed: e.target.value})} />
                            </div>
                            <div className="glass rounded-2xl p-4">
                                <div className="flex items-center gap-2 mb-2 text-slate-400"><Icons.Box size={16}/><span className="text-xs font-bold uppercase">Parts Used</span></div>
                                <textarea className="w-full p-3 rounded-xl text-white outline-none text-sm" placeholder="List parts..." defaultValue={job.partsUsed} onBlur={(e) => updateJob({partsUsed: e.target.value})} />
                            </div>
                        </div>

                        <div className="grid grid-cols-3 gap-3 pt-2">
                            <button onClick={() => window.open(`https://maps.google.com/?q=${encodeURIComponent(job.address)}`, '_blank')} className="glass p-3 rounded-xl flex flex-col items-center justify-center gap-1 text-blue-400 hover:bg-slate-800"><Icons.Navigation size={20}/><span className="text-[10px] font-bold uppercase">Map</span></button>
                            <button onClick={() => {navigator.clipboard.writeText(job.address); alert('Copied');}} className="glass p-3 rounded-xl flex flex-col items-center justify-center gap-1 text-slate-400 hover:bg-slate-800"><Icons.MapPin size={20}/><span className="text-[10px] font-bold uppercase">Copy</span></button>
                            <button onClick={handleExport} className="glass p-3 rounded-xl flex flex-col items-center justify-center gap-1 text-emerald-400 hover:bg-slate-800"><Icons.Download size={20}/><span className="text-[10px] font-bold uppercase">Export</span></button>
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
```eof
